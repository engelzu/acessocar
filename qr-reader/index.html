<!DOCTYPE html>

<html class="dark" lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Leitor QR Code - Entrada/Saída</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />

    <!-- HTML5-QRCode Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Firebase Init -->
    <script src="../js/firebase-init.js"></script>

    <!-- Auth Protection -->
    <script>
        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = '../login/index.html';
            }
        });
    </script>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }

        #reader video {
            object-fit: cover !important;
            border-radius: 12px;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark min-h-screen font-display antialiased selection:bg-primary/30 text-slate-900 dark:text-white">
    <div class="relative flex flex-col h-screen w-full overflow-hidden max-w-md mx-auto shadow-2xl bg-black">
        <!-- Header Overlay -->
        <div class="absolute top-0 left-0 right-0 z-20 pt-12 pb-4 px-4 bg-gradient-to-b from-black/80 to-transparent">
            <div class="flex items-center justify-between">
                <button onclick="window.location.href='../dashboard/index.html'"
                    class="flex items-center justify-center size-10 rounded-full bg-white/10 backdrop-blur-md text-white hover:bg-white/20 transition-colors">
                    <span class="material-symbols-outlined text-xl">arrow_back</span>
                </button>
                <h2 class="text-white text-lg font-bold tracking-tight">Leitor de Acesso</h2>
            </div>
        </div>

        <!-- Camera Area -->
        <div class="relative flex-1 bg-gray-900 flex flex-col items-center justify-center overflow-hidden">
            <div id="reader" style="width: 100%; height: 100%;"></div>

            <!-- Scanning Overlay (Visual Only) -->
            <div id="scanOverlay"
                class="absolute inset-0 pointer-events-none flex flex-col items-center justify-center z-10">
                <div
                    class="relative size-64 border-2 border-primary/50 rounded-3xl bg-transparent shadow-[0_0_0_9999px_rgba(0,0,0,0.7)] flex flex-col items-center justify-center">
                    <!-- Corner Markers -->
                    <div
                        class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-primary -mt-1 -ml-1 rounded-tl-xl">
                    </div>
                    <div
                        class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-primary -mt-1 -mr-1 rounded-tr-xl">
                    </div>
                    <div
                        class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-primary -mb-1 -ml-1 rounded-bl-xl">
                    </div>
                    <div
                        class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-primary -mb-1 -mr-1 rounded-br-xl">
                    </div>
                    <!-- Animation -->
                    <div
                        class="w-full h-0.5 bg-primary shadow-[0_0_15px_rgba(19,91,236,0.8)] animate-[scan_2s_ease-in-out_infinite]">
                    </div>
                </div>
                <!-- Hint Text -->
                <div class="absolute bottom-24 z-20 w-full text-center px-6">
                    <div
                        class="inline-flex items-center justify-center gap-2 px-4 py-2 bg-black/60 backdrop-blur-md rounded-full border border-white/10">
                        <span class="material-symbols-outlined text-primary text-sm">qr_code_scanner</span>
                        <p class="text-white/90 text-sm font-medium">Aponte para o QR Code</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Result/Action Sheet (Initially Hidden) -->
        <div id="resultSheet"
            class="hidden absolute bottom-0 inset-x-0 bg-background-light dark:bg-[#1a202c] rounded-t-3xl shadow-[0_-4px_20px_rgba(0,0,0,0.4)] z-30 pb-6 transition-transform duration-300">
            <!-- Drag Handle -->
            <div class="w-full flex justify-center pt-3 pb-1">
                <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
            </div>
            <div class="px-5 pt-2 pb-6 space-y-5">
                <!-- Status Header -->
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Veículo Identificado</h3>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span id="resPlate" class="text-xl font-bold text-gray-900 dark:text-white">---</span>
                            <span id="resStatus"
                                class="px-2 py-0.5 rounded text-[10px] font-bold bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800">LIBERADO</span>
                        </div>
                        <p id="resModel" class="text-xs text-gray-400">---</p>
                    </div>
                    <div class="text-right">
                        <button id="closeSheetBtn" class="text-primary font-bold text-sm">Fechar</button>
                    </div>
                </div>
                <!-- Segmented Control (Entrada/Saída) -->
                <div class="bg-gray-200 dark:bg-[#111722] p-1 rounded-xl flex relative">
                    <label class="flex-1 cursor-pointer">
                        <input checked="" class="peer sr-only" name="access_type" type="radio" value="entry" />
                        <div
                            class="py-2.5 text-center text-sm font-medium rounded-lg text-gray-500 dark:text-gray-400 transition-all peer-checked:bg-white dark:peer-checked:bg-[#232f48] peer-checked:text-primary peer-checked:shadow-sm">
                            Entrada
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input class="peer sr-only" name="access_type" type="radio" value="exit" />
                        <div
                            class="py-2.5 text-center text-sm font-medium rounded-lg text-gray-500 dark:text-gray-400 transition-all peer-checked:bg-white dark:peer-checked:bg-[#232f48] peer-checked:text-primary peer-checked:shadow-sm">
                            Saída
                        </div>
                    </label>
                </div>
                <!-- Observation Input -->
                <div class="space-y-1.5">
                    <label class="text-xs font-medium text-gray-500 dark:text-gray-400 ml-1"
                        for="obs">Observação</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="material-symbols-outlined text-gray-400 text-lg">edit_note</span>
                        </div>
                        <input
                            class="block w-full pl-10 pr-3 py-3 text-sm rounded-xl border-none bg-white dark:bg-[#111722] text-gray-900 dark:text-white shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-700 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary dark:focus:ring-primary sm:leading-6"
                            id="obs" placeholder="Ex: Visitante, Entrega..." type="text" />
                    </div>
                </div>
                <!-- Submit Button -->
                <button id="confirmBtn"
                    class="w-full flex items-center justify-center gap-2 rounded-xl bg-primary px-4 py-3.5 text-sm font-semibold text-white shadow-lg shadow-primary/20 hover:bg-blue-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary transition-colors"
                    type="button">
                    <span class="material-symbols-outlined text-xl">check_circle</span>
                    Confirmar Registro
                </button>
            </div>
        </div>
    </div>

    <!-- Animation Keyframes for Scanner -->
    <style>
        @keyframes scan {

            0%,
            100% {
                transform: translateY(0);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            50% {
                transform: translateY(250px);
                opacity: 1;
            }

            90% {
                opacity: 1;
            }
        }

        /* Ensure video fills container */
        #reader {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
        }
    </style>

    <script>
        let html5QrcodeScanner;
        let currentVehicle = null;
        let lastMovementType = null; // 'entry' or 'exit'

        function startScanner() {
            html5QrcodeScanner = new Html5Qrcode("reader");

            // Config using fixed box size to match visual overlay (250px)
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                experimentalFeatures: {
                    useBarCodeDetectorIfSupported: true
                },
                formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE]
            };

            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .catch(err => {
                    console.error("Error starting scanner", err);
                    document.getElementById('reader').innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-white p-4 text-center">
                        <span class="material-symbols-outlined text-4xl mb-2 text-red-500">videocam_off</span>
                        <p>Não foi possível iniciar a câmera.</p>
                        <p class="text-sm opacity-70 mt-2">${err}</p>
                    </div>
                `;
                });
        }

        async function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result: ${decodedText}`, decodedResult);
            html5QrcodeScanner.pause();

            try {
                // 1. Fetch Vehicle Data
                const doc = await db.collection('vehicles').doc(decodedText).get();
                if (doc.exists) {
                    currentVehicle = { id: doc.id, ...doc.data() };

                    // 2. Fetch Last Movement for Status
                    // FIX: Sorting in JS to avoid creating a composite index in Firestore for where+orderBy
                    const historySnap = await db.collection('history')
                        .where('vehicleId', '==', currentVehicle.id)
                        .get();

                    lastMovementType = null;
                    if (!historySnap.empty) {
                        // Find latest by timestamp in client-side
                        const docs = historySnap.docs.map(d => d.data());
                        docs.sort((a, b) => {
                            // Handle pending writes (null timestamp) as 'Now' (Highest priority)
                            const tA = a.timestamp ? a.timestamp.seconds : Number.MAX_SAFE_INTEGER;
                            const tB = b.timestamp ? b.timestamp.seconds : Number.MAX_SAFE_INTEGER;
                            return tB - tA; // Descending (newest first)
                        });
                        lastMovementType = docs[0].type;

                        // Debug (Optional, can remove if annoying)
                        console.log("Last Movement Detected:", lastMovementType);
                    }

                    showResult(currentVehicle, lastMovementType);
                } else {
                    alert("Veículo não encontrado ou QR Code inválido.");
                    html5QrcodeScanner.resume();
                }
            } catch (error) {
                console.error("Error fetching vehicle:", error);
                alert("Erro ao buscar veículo.");
                html5QrcodeScanner.resume();
            }
        }

        function onScanFailure(error) {
            // handle error
        }

        function showResult(vehicle, lastType) {
            // Update Text
            document.getElementById('resPlate').innerText = vehicle.plate;
            document.getElementById('resModel').innerText = vehicle.model + ' • ' + vehicle.color;

            // Update Status Badge logic
            const statusBadge = document.getElementById('resStatus');
            const entryRadio = document.querySelector('input[name="access_type"][value="entry"]');
            const exitRadio = document.querySelector('input[name="access_type"][value="exit"]');

            if (lastType === 'entry') {
                statusBadge.innerText = 'DENTRO';
                statusBadge.className = "px-2 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 border border-blue-200 dark:border-blue-800";
                // Auto-select Exit
                exitRadio.checked = true;
            } else if (lastType === 'exit') {
                statusBadge.innerText = 'FORA';
                statusBadge.className = "px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400 border border-gray-200 dark:border-gray-700";
                // Auto-select Entry
                entryRadio.checked = true;
            } else {
                statusBadge.innerText = 'NOVO';
                statusBadge.className = "px-2 py-0.5 rounded text-[10px] font-bold bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800";
                entryRadio.checked = true;
            }

            document.getElementById('scanOverlay').classList.add('hidden');
            document.getElementById('resultSheet').classList.remove('hidden');
        }

        function closeResult() {
            document.getElementById('resultSheet').classList.add('hidden');
            document.getElementById('scanOverlay').classList.remove('hidden');
            document.getElementById('obs').value = '';
            currentVehicle = null;
            lastMovementType = null;
            html5QrcodeScanner.resume();
        }

        document.getElementById('closeSheetBtn').addEventListener('click', closeResult);

        document.getElementById('confirmBtn').addEventListener('click', async () => {
            if (!currentVehicle) return;

            const selectedType = document.querySelector('input[name="access_type"]:checked').value;

            // WARNING CHECK logic
            if (lastMovementType && lastMovementType === selectedType) {
                const action = selectedType === 'entry' ? 'ENTRADA' : 'SAÍDA';
                // Wait for UI to render alert properly by small timeout if needed, but alert blocks execution so it's fine.
                const msg = `ATENÇÃO:\n\nEste veículo já consta com registro de ${action} anterior.\nIsso significa que o movimento oposto não foi registrado.\n\nDeseja registrar ${action} novamente mesmo assim?`;

                if (!confirm(msg)) {
                    return; // Abort if user cancels
                }
            }

            const btn = document.getElementById('confirmBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Salvando...';
            btn.disabled = true;

            const obs = document.getElementById('obs').value;

            try {
                await db.collection('history').add({
                    vehicleId: currentVehicle.id,
                    plate: currentVehicle.plate,
                    model: currentVehicle.model,
                    type: selectedType, // 'entry' or 'exit'
                    obs: obs,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Registro salvo com sucesso!');
                window.location.href = '../dashboard/index.html';

            } catch (error) {
                console.error("Error saving history:", error);
                alert("Erro ao salvar registro.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // Start immediately
        window.addEventListener('load', startScanner);

    </script>
</body>

</html>
